# 振り返り - Phase 1 & 2 完了

日時: 2026-01-20 00:34

## 今回何をしたか

### Phase 1: コンパイラ起動検証 (技術的PoC)
1. **プロジェクトの基本セットアップ**
   - Vite + PReact + TypeScript環境を構築
   - 必要な依存パッケージのインストール
     - `@moonbit/moonc-worker` v0.1.x
     - `comlink` (Worker通信用)
     - `@picocss/pico` v2 (CSSフレームワーク)
   - プロジェクト構造の作成 (`src/`, `public/` ディレクトリ)
   - `vite.config.ts`, `tsconfig.json`, `index.html` の設定

2. **MoonBitコンパイラのブラウザ動作検証**
   - `compiler.ts` を作成し、`MoonbitCompiler` クラスを実装
   - `@moonbit/moonc-worker` を Web Worker として起動
   - `comlink` を使用したWorkerのラッパー実装
   - `buildPackage` APIでMoonBitコードをコアファイルにコンパイル
   - `linkCore` APIでWASMバイナリを生成
   - 簡単なMoonBitコード (`fn main { let x = 42 }`) のコンパイルに成功

### Phase 2: ランタイム接続
1. **WASM実行環境の構築**
   - `WebAssembly.instantiate` を使用した実行ローダーを実装
   - `spectest.print_char` をフックして標準出力をキャプチャ
   - コンパイルされたWASMの実行に成功
   - 出力結果をUIに表示

2. **基本UIの作成**
   - PReact + Pico.cssでダークモードのUIを構築
   - コードエディタ (textarea)
   - Runボタン
   - 出力エリア
   - Chrome DevTools MCPで動作確認

## どのようなアクシデントに遭遇したのか

1. **npm create viteがハングする問題**
   - `npm create vite@latest . -- --template preact-ts` が確認プロンプトで止まった
   - **解決**: 手動で `npm init -y` してから必要なパッケージを個別にインストール

2. **MoonBit構文エラー**
   - 初期コード `pub fn main() { println("Hello, MoonBit!") }` がコンパイルエラー
   - エラー内容:
     - `pub` 修飾子は main 関数では不要
     - `()` パラメータリストは不要（正しい構文: `fn main { ... }`）
     - `println` が未定義（標準ライブラリが必要）
   - **解決**: `fn main { let x = 42 }` にシンプル化

3. **WASM形式エラー**
   - 最初 `target: 'js'` を指定していたため、WASMバイナリではなくテキスト形式が出力された
   - エラー: `expected magic word 00 61 73 6d, found 28 28 29 20`
   - **解決**: `target: 'wasm'` に変更して正しいバイナリを生成

4. **標準ライブラリの不足**
   - `println` などの標準関数を使用するには `stdMiFiles` の設定が必要
   - 現時点では標準ライブラリのロード方法が不明
   - **暫定対応**: 標準ライブラリを使わないシンプルなコードで検証

## どのような見込み違いに遭遇したのか

1. **MoonBit構文の理解不足**
   - main関数の正しい構文が `fn main { ... }` であることを知らなかった
   - 戻り値は `Unit` でなければならない制約を理解していなかった
   - Rustのような `pub fn main()` 構文だと思い込んでいた

2. **標準ライブラリのロード方法**
   - info.mdに記載されていた `Core.getLoadPkgsParams("js")` は `moonpad-monaco` パッケージ固有の実装
   - `@moonbit/moonc-worker` 単体には標準ライブラリロード用のヘルパー関数がない
   - 標準ライブラリファイル（.miファイル）を別途取得・配信する必要がある

3. **target パラメータの重要性**
   - `target: 'js'` と `target: 'wasm'` の違いが出力形式に大きく影響
   - 最初は `outputFormat: 'wasm'` だけで十分だと思っていた
   - 両方のパラメータを正しく設定する必要があった

## 残りのタスク

### Phase 3: UI構築 & 統合
1. **PReact + Pico.css でのUI改善**
   - [ ] Header コンポーネントの改善（GitHubリンク追加）
   - [ ] Editor Area の改善（行番号、シンタックスハイライトの検討）
   - [ ] Action Bar の改善（共有ボタン追加）
   - [ ] Output Area の改善（エラーメッセージの整形）
   - [ ] ダークモードのスタイル調整

2. **Web Workerの適切な統合**
   - [ ] 現在はメインスレッドで実行中なのでWorkerに移動
   - [ ] Worker用の専用ファイル作成
   - [ ] comlink を使った型安全なメッセージング実装

3. **UIとWorkerの接続改善**
   - [ ] エラーハンドリングの改善
   - [ ] ローディング状態の視覚的改善
   - [ ] コンパイルエラーの詳細表示（行番号、エラーコード）

4. **URL共有機能**
   - [ ] ソースコードのBase64エンコード実装
   - [ ] URLハッシュへの埋め込み
   - [ ] ページロード時のハッシュからのコード復元
   - [ ] 共有ボタンのUI実装

### テスト・検証
- [ ] 基本動作確認
  - [x] 簡単なプログラムのコンパイル・実行
  - [ ] コンパイルエラーの適切な表示
  - [ ] 標準出力の正常な表示（標準ライブラリ対応後）
- [ ] ブラウザ動作確認
  - [x] Chrome DevTools MCPでの確認
  - [ ] モバイルデバイスでの表示確認
  - [ ] ダークモードの動作確認

### ドキュメント
- [ ] README.mdの更新
  - [ ] セットアップ手順
  - [ ] 使い方
  - [ ] 技術スタック
  - [ ] 開発手順
  - [ ] 制限事項（標準ライブラリ未対応など）

### 技術的課題（今後の対応）
1. **標準ライブラリの統合**
   - `println`, `print`, `debug` などの標準関数を使えるようにする
   - `.mi` ファイルの取得方法を調査
   - 標準ライブラリファイルの配信方法を検討

2. **コンパイラエラーの改善**
   - JSON形式のエラーメッセージをパース
   - 行番号、カラム番号、エラーコードを表示
   - エラー箇所のハイライト

3. **パフォーマンス最適化**
   - Worker での非同期処理
   - WASMバイナリのキャッシング
   - 標準ライブラリの遅延ロード

## 現状の成果

✅ MoonBitコードをブラウザ上でコンパイルして実行できる基本的な仕組みが完成
✅ Phase 1 と Phase 2 の全タスクを完了
✅ 動作するMVPプロトタイプが完成

次のステップ: Phase 3 のUI改善とURL共有機能の実装に進む
