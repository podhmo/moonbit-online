# 振り返り - println実装の試行

日時: 2026-01-20 01:14

## 今回何をしたか

### println機能の実装を試みた

1. **標準ライブラリの調査**
   - `@moonbit/moonc-worker`パッケージには標準ライブラリが含まれていないことを確認
   - moonpad-monacoのvendorコードを調査
   - `core`パッケージが標準ライブラリをバンドルする仕組みを発見

2. **moon CLIのインストール**
   - 公式インストールスクリプトを使用: `curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash`
   - moon 0.1.20260110 (0.7.1+adb125543) をインストール
   - 標準ライブラリが自動的にビルドされた（~/.moon/lib/core/）

3. **標準ライブラリファイルの配置**
   - `~/.moon/lib/core/target/js/release/bundle/`から65個の.miファイルをコピー
   - `public/lib/core/`ディレクトリに配置
   - stdlib.tsを作成してロード処理を実装

4. **統合とテスト**
   - compiler.tsを更新してstdMiFilesを使用
   - デフォルトコードを`println("Hello, MoonBit!")`に変更
   - ブラウザでテスト実行

## どのようなアクシデントに遭遇したのか

1. **Magic number mismatch エラー**
   - 標準ライブラリの.miファイルをロードできたが、コンパイル時にエラー
   - エラーメッセージ:
     ```
     Magic number mismatch for the package file of moonbitlang/core/fixedarray
     Magic number mismatch for the package file of moonbitlang/core/intrinsics/wasm
     Magic number mismatch for the package file of moonbitlang/core/iter
     Magic number mismatch for the package file of moonbitlang/core/js
     Magic number mismatch for the package file of moonbitlang/core/map
     Magic number mismatch for the package file of moonbitlang/core/vec
     ```
   - 一部のパッケージ（全部で6個）のみでエラーが発生

2. **バージョン互換性の問題**
   - `@moonbit/moonc-worker@0.1.202601103`のバージョン
   - moon CLI 0.7.1+adb125543のバージョン
   - どちらも同じリリース（202601103 = 2026-01-10）のはずだが、.miファイルのバイナリフォーマットが異なる

3. **moonpad-monacoの調査が不十分**
   - moonpad-monacoパッケージをインストールしたが、そこに標準ライブラリは含まれていなかった
   - compile関数はJS出力のみを提供（WASM出力が必要）

## どのような見込み違いに遭遇したのか

1. **標準ライブラリの入手方法**
   - 最初は`@moonbit/moonpad-monaco`に標準ライブラリが含まれていると思った
   - 実際にはビルド時に生成されるものだった
   - npmパッケージとして配布されていない

2. **.miファイルのバージョン互換性**
   - 同じバージョン番号なら互換性があると思った
   - 実際には、異なるビルド方法（CLI vs npmパッケージ）で微妙な違いが生じる
   - 「Magic number」はバイナリフォーマットのバージョンチェック

3. **すべてのパッケージでエラーが出ると思った**
   - 実際には65個中6個のみでエラー
   - fixedarray, intrinsics/wasm, iter, js, map, vecの6つ
   - これらは特殊な機能を持つパッケージの可能性

4. **パスの形式**
   - 最初は`moonbitlang/core/PKG:moonbitlang/core/PKG`形式
   - 後で`/lib/core/PKG:moonbitlang/core/PKG`形式に変更
   - しかし、どちらでもMagic number mismatchエラーは解決せず

## 残りのタスク

### 優先度：高（println実装）

1. **vendor/moonbit-docs/moonbit-tourの調査**（次のステップ）
   - そこでprintlnが使われているなら解決策があるはず
   - どのように標準ライブラリをロードしているか確認
   - 使用している.miファイルのバージョンや取得方法を確認

2. **代替アプローチの検討**
   - オプションA: moonbit-tourと同じ方法を使う
   - オプションB: 特定の6つのパッケージを除外してロード
   - オプションC: 別のバージョンの標準ライブラリを試す

### 技術的課題

1. **Magic number mismatch の根本原因**
   - なぜ6つのパッケージだけでエラーが出るのか
   - これらのパッケージの特徴は何か
   - 回避する方法はあるか

2. **バージョン整合性の確保**
   - npmパッケージと互換性のある標準ライブラリの入手方法
   - ビルド済みの標準ライブラリが配布されているか
   - moonpad-monacoが実際にどう実装しているか

### 暫定対応

現在は標準ライブラリなしで動作（制限事項として明記）:
- ✅ 基本的な演算は動作
- ❌ println, print, debugなどの標準関数は使用不可
- ❌ 標準ライブラリの型やデータ構造は使用不可

## 現状の成果

✅ **動作している機能**
- MoonBitコードのコンパイル（標準ライブラリなし）
- WASM実行
- UI全般
- URL共有

❌ **動作していない機能**
- println等の標準関数
- 標準ライブラリの利用

## 次のステップ

1. **vendor/moonbit-docs/moonbit-tourを調査**（最優先）
   - ディレクトリ構造の確認
   - 標準ライブラリのロード方法の確認
   - printlnの実装方法の確認

2. その結果に基づいて実装を修正

3. 動作確認とテスト

## 学んだこと

- MoonBitの標準ライブラリは.miファイル形式で配布される
- .miファイルにはバイナリフォーマットのバージョン（Magic number）がある
- npmパッケージとローカルビルドで微妙な違いが生じる
- 同じバージョン番号でも完全な互換性があるとは限らない
- moonbit-tourの実装例を最初に確認すべきだった
