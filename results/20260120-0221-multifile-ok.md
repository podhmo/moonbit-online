# 振り返り: 複数ファイル対応の実装

**日時**: 2026-01-20 02:21  
**ステータス**: ✅ 成功  
**実装フェーズ**: 追加機能 - 複数ファイル対応

## 実装内容

### 目標
go-playground方式の複数ファイル対応を実装し、`-- filename --`区切りで複数のMoonBitファイルをサポートする

### 実施した作業

1. **ファイル解析関数の実装**
   - `parseMultipleFiles()`関数を作成
   - `-- filename --`パターンで区切りを検出
   - 最初のファイルは`main.mbt`、その後のファイル名を認識
   - 各ファイルの内容を配列に格納

2. **compiler.tsの拡張**
   - `compileMultiple(files: Array<[string, string]>)`メソッドを追加
   - 既存の`compile()`メソッドを`compileMultiple()`を呼び出すように変更
   - `libInputs`に複数ファイルを渡す

3. **app.tsxの更新**
   - `handleRun()`で`parseMultipleFiles()`を使用
   - `compiler.compileMultiple()`を呼び出し
   - デフォルトコードを複数ファイルの例に変更

4. **デフォルトコードの改善**
   - 2ファイル構成のサンプル（main.mbt + lib.mbt）
   - lib.mbtに`hello()`関数を定義
   - 返り値の型アノテーション（`-> Unit`）を追加

## 技術的な詳細

### ファイル解析ロジック

```typescript
function parseMultipleFiles(source: string): Array<[string, string]> {
  const files: Array<[string, string]> = [];
  const lines = source.split('\n');
  
  let currentFile = 'main.mbt';
  let currentContent: string[] = [];
  
  for (const line of lines) {
    // Check for file separator: -- filename --
    const match = line.match(/^--\s+(.+?)\s+--$/);
    if (match) {
      // Save previous file
      if (currentContent.length > 0 || files.length === 0) {
        files.push([currentFile, currentContent.join('\n')]);
      }
      // Start new file
      currentFile = match[1].trim();
      currentContent = [];
    } else {
      currentContent.push(line);
    }
  }
  
  // Save last file
  if (currentContent.length > 0 || files.length === 0) {
    files.push([currentFile, currentContent.join('\n')]);
  }
  
  return files;
}
```

### コンパイラAPI

moonpad-monacoの`compile()`は複数ファイルをサポート：

```typescript
moon.compile({
  libInputs: [
    ['main.mbt', mainContent],
    ['lib.mbt', libContent],
    ['utils.mbt', utilsContent]
  ],
  debugMain: true
})
```

## 動作確認

### テスト1: 基本的な2ファイル構成
```moonbit
fn main {
  hello()
}
-- lib.mbt --
pub fn hello() -> Unit {
  println("Hello from lib.mbt!")
  let x = 42
  println("x = \{x}")
}
```
**結果**: ✅ 正常に動作

### テスト2: 複雑な3ファイル構成
```moonbit
fn main {
  let result = add(10, 20)
  println("10 + 20 = \{result}")
  
  let nums = [1, 2, 3, 4, 5]
  let total = sum(nums)
  println("Sum of \{nums} = \{total}")
}
-- lib.mbt --
pub fn add(a : Int, b : Int) -> Int {
  a + b
}

pub fn sum(arr : Array[Int]) -> Int {
  let mut total = 0
  for i = 0; i < arr.length(); i = i + 1 {
    total = total + arr[i]
  }
  total
}
```
**結果**: ✅ 正常に動作  
**出力**:
```
10 + 20 = 30
Sum of [1, 2, 3, 4, 5] = 15
```

## 学んだこと

1. **MoonBitの型システム**
   - pub関数には返り値の型アノテーションが必須（`-> Unit`）
   - ファイル内の関数は同じパッケージに属する
   - モジュール名は大文字で始まる必要がある（使わない場合は同一パッケージ）

2. **ファイル解析の注意点**
   - 最後のファイルも確実に保存する必要がある
   - 空のファイルも許可する（最初のファイルが空の場合）
   - 区切り行の前後の空白を処理する

3. **後方互換性の維持**
   - `compile()`メソッドは`compileMultiple()`のラッパーとして保持
   - 単一ファイルの使用も引き続きサポート

## 改善点

### 実装済み ✅
- 複数ファイルの解析と コンパイル
- go-playground方式の`-- filename --`区切り
- エラーメッセージにファイル名とパス表示

### 今後の拡張案
- [ ] ファイル数の表示（例: "2 files"）
- [ ] ファイル名のバリデーション（.mbt拡張子のチェック）
- [ ] タブUIでファイルを視覚的に切り替える
- [ ] moon.pkg.jsonのサポート

## 成果物

### 更新ファイル
- src/app.tsx: `parseMultipleFiles()`関数とデフォルトコード
- src/compiler.ts: `compileMultiple()`メソッド

### スクリーンショット
- results/screenshot-multifile.png: 基本的な2ファイル構成
- results/screenshot-multifile-complex.png: 複雑な3ファイル構成

## 結論

go-playground方式の複数ファイル対応が成功しました。
`-- filename --`区切りにより、1つのテキストエリアで複数ファイルを扱えるようになり、
より実用的なMoonBitコードの実験が可能になりました。

**追加機能が完成し、正常に動作しています。** 🎉
