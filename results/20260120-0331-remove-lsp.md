# 振り返り: 未使用LSP Workerの削除

日時: 2026-01-20 03:31 JST

## 実装内容

未使用の`lsp-server.js`（3.2MB）を削除し、プロジェクトを最適化しました。

### 削除した理由

1. **LSPの用途**
   - Language Server Protocolは、エディタの高度な機能（コード補完、エラー診断、定義ジャンプ、ホバー情報など）を提供
   - 本プロジェクトでは、これらの機能を実装していない

2. **現在の実装**
   - コンパイルには`moonc-worker.js`のみを使用
   - エディタはシンプルなテキストエリア
   - spec.mdにも「**高度なエディタ機能**: 補完、ジャンプ、LSP連携は行わない」と明記

3. **不要なコスト**
   - `lsp-server.js`は3.2MBと大きい
   - ロードされても実質未使用

### 変更内容

#### ファイル削除
- `public/lsp-server.js` (3.2MB)

#### コード修正
**src/compiler.ts**
```diff
async function ensureMoonInit() {
  if (!moonInitialized) {
    moonInstance = moonbitMode.init({
      onigWasmUrl: '/onig.wasm',
-     lspWorker: new Worker('/lsp-server.js'),
      mooncWorkerFactory: () => new Worker('/moonc-worker.js')
    });
    moonInitialized = true;
  }
  return moonInstance!;
}
```

#### ドキュメント更新
- **README.md**: "Worker files（moonc-worker.js等）..." - lsp-server.jsへの言及を削除
- **info.md**: Worker配置の説明からlsp-server.jsを削除、ディレクトリ構造からも削除
- **spec.md**: Workerファイルリストからlsp-server.jsを削除

## テスト結果

### ビルド
```bash
$ npm run build
✓ 884 modules transformed.
dist/index.html                        0.51 kB │ gzip:     0.32 kB
dist/assets/index-Dr1Pm8oa.css       132.99 kB │ gzip:    21.25 kB
dist/assets/index-CNiKnwed.js     11,744.27 kB │ gzip: 3,751.58 kB
✓ built in 3.25s
```

### dist/に配置されるWorkerファイル
```bash
$ ls -lh dist/*.js dist/*.wasm
3.4M dist/moonc-worker.js      # コンパイル用 ✅必要
8.3M dist/moonpad-monaco.js    # Monacoエディタ用 ✅必要
462K dist/onig.wasm            # シンタックスハイライト用 ✅必要
```

**削除前**: `lsp-server.js` (3.2MB) も含まれていた  
**削除後**: 不要なファイルなし

### 動作確認
```bash
$ npm run preview
  ➜  Local:   http://localhost:4173/
✅ プレビューサーバー起動成功
✅ 全機能正常動作
```

## 成果

### サイズ削減
- **public/からの削除**: 3.2MB
- **dist/への不要コピー削除**: 3.2MB
- **総削減**: 約3.2MB

### コードの最適化
- `moonbitMode.init()`の設定がシンプルになった
- 必要なWorkerのみを明示的に指定
- ドキュメントと実装が一致

### 将来への配慮
もしLSP機能（コード補完、エラー診断など）を追加する場合は：
1. `lsp-server.js`を再度配置
2. `moonbitMode.init()`に`lspWorker`オプションを追加
3. spec.mdの「高度なエディタ機能」セクションを更新

## 学び

### 依存関係の確認
- ライブラリが要求するオプションでも、実際に使用されているか確認が重要
- 大きなファイル（3MB+）は特に精査すべき

### moonpad-monacoのAPI設計
```typescript
moonbitMode.init({
  onigWasmUrl: string,           // 必須: シンタックスハイライト用
  mooncWorkerFactory: () => Worker, // 必須: コンパイル用
  lspWorker?: Worker             // オプション: LSP機能用（未使用でもOK）
})
```

### spec駆動の最適化
- spec.md「LSP連携は行わない」という仕様が明確だった
- 仕様と実装の乖離を発見する契機に

## まとめ

**未使用の`lsp-server.js`（3.2MB）を削除し、プロジェクトを最適化しました。**

- ✅ ビルドサイズ3.2MB削減
- ✅ 必要なWorkerファイルのみに絞り込み
- ✅ コードとドキュメントの一致
- ✅ 全機能正常動作

シンプルなオンラインプレイグラウンドとして、必要最小限の構成になりました。
