# 振り返り - 20260130-1829

## 今回何をしたか

GitHub Pages (https://podhmo.github.io/moonbit-online/) でコンパイルエラーが発生する問題を調査し、解決しました。

### 実施内容
1. Chrome DevTools MCPを使用してGitHub Pagesの実際の動作を確認
2. "Cannot read properties of undefined (reading 'length')" エラーを再現
3. デプロイされたmoonc-worker.jsとローカルのdist/moonc-worker.jsを比較
4. 依存パッケージのバージョン差異を発見
5. `@moonbit/moonpad-monaco`のバージョンを`0.1.202510171`に固定
6. package.json, package-lock.jsonを更新
7. ローカルで動作確認（npm run dev, npm run preview両方で成功）

## どのようなアクシデントに遭遇したのか

### 1. 当初の誤った仮説
- 最初はWorkerのパス解決やES module対応（`{ type: 'module' }`）の問題だと推測
- しかしローカルでは動作していたため、これらは原因ではなかった

### 2. 依存パッケージのバージョン不一致
- package.jsonには`^0.1.202510171`（キャレット付き）と指定
- package-lock.jsonには`0.1.202601213`がインストールされていた
- GitHub ActionsのCIでは新しいバージョンがインストールされ、エラーが発生
- ローカルではnode_modulesがキャッシュされていたため、古いバージョンが残っており動作していた

### 3. 新バージョンの非互換性
- `@moonbit/moonpad-monaco@0.1.202601213`でAPIが変更されたか、バグが混入
- compile関数内で`undefined.length`にアクセスしてエラーが発生
- 詳細な原因は不明だが、データ構造の期待値が変わった可能性が高い

## どのような見込み違いに遭遇したのか

### 1. ローカルとCI環境の違い
- ローカルで動作していたため「デプロイの設定問題」だと考えた
- 実際は依存パッケージのバージョン違いが原因だった
- node_modules/publicディレクトリが.gitignoreされており、環境による差異が見えにくかった

### 2. セマンティックバージョニングの前提
- `0.1.202510171`から`0.1.202601213`はマイナーバージョンアップに見えるが、
- 実際には破壊的変更が含まれていた
- moonpad-monacoパッケージはまだ実験的段階（0.1系）のため、後方互換性が保証されていない

### 3. ビルド済みファイルの比較
- 最初にdist/moonc-worker.jsを比較したが、その時点ではローカルも古いバージョンだった
- npm ciで再インストール後、ファイルが一致したため「問題ない」と誤判断しかけた
- ユーザーが「node_modules, publicを削除して再現した」という情報で真因にたどり着けた

## 残りのタスク

### 1. デプロイ（推奨）
- package.json, package-lock.jsonの変更をコミット＆プッシュ
- GitHub Actionsで自動デプロイが走り、修正版がGitHub Pagesに反映される

### 2. 監視（オプション）
- @moonbit/moonpad-monacoの新バージョンリリースを監視
- バージョン`0.1.202601213`のchangelogやissueを確認し、何が変わったのか調査
- 将来的に新バージョン対応が必要になる可能性

### 3. ドキュメント更新（推奨）
- README.mdに「バージョンを固定している理由」を記載
- または技術的な詳細セクションに、バージョン固定についての注意書きを追加

## 学び

- **依存パッケージのバージョン固定の重要性**: 実験的なパッケージは明示的にバージョンを固定すべき
- **Chrome DevTools MCPの有用性**: 本番環境の問題を直接デバッグできるのは非常に強力
- **環境の差異を意識する**: .gitignoreされたディレクトリの内容は環境によって異なる
- **ユーザーの協力が重要**: 「ローカルで再現した」という情報が決定的だった
