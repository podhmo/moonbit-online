#!/usr/bin/env node
// Extracts stdlib MI files and core.core.gz from public/moonpad-monaco.js
// and generates src/core/core-map.js for use in Node.js tests.
import { readFileSync, writeFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import { gunzipSync } from 'zlib';

const __dir = dirname(fileURLToPath(import.meta.url));
const monacoPath = join(__dir, '../public/moonpad-monaco.js');
const outputPath = join(__dir, '../src/core/core-map.js');

const content = readFileSync(monacoPath, 'utf-8');

// Extract corePkgs from all_pkgs.json embedded as Q()
const allPkgsJsVarMatch = content.match(/X\["\/lib\/core\/_build\/js\/release\/bundle\/all_pkgs\.json"\]\s*=\s*([A-Za-z0-9_]+)/);
if (!allPkgsJsVarMatch) throw new Error('Could not find all_pkgs.json var in moonpad-monaco.js');
const allPkgsVarName = allPkgsJsVarMatch[1];
const allPkgsVarRegex = new RegExp('\\b' + allPkgsVarName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\s*=\\s*Q\\("([^"]+)"\\)');
const allPkgsVm = allPkgsVarRegex.exec(content);
if (!allPkgsVm) throw new Error('Could not find all_pkgs.json data in moonpad-monaco.js');
const allPkgsData = JSON.parse(Buffer.from(allPkgsVm[1], 'base64'));
const corePkgs = allPkgsData.packages.map(p => p.rel);

// Extract JS-target MI file entries: X["/lib/core/_build/js/..."] = varName
const miMap = {};
const miRegex = /X\["(\/lib\/core\/_build\/js\/release\/bundle\/[^"]+\.mi)"\]\s*=\s*([A-Za-z0-9_]+)/g;
let m;
while ((m = miRegex.exec(content)) !== null) {
  const path = m[1];
  const varName = m[2];
  const varRegex = new RegExp('\\b' + varName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\s*=\\s*Q\\("([^"]+)"\\)');
  const vm = varRegex.exec(content);
  if (vm) {
    miMap[path] = vm[1]; // base64-encoded MI file content
  }
}

// Extract core.core.gz (the bundled standard library)
const coreGzMatch = content.match(/X\["\/lib\/core\/_build\/js\/release\/bundle\/core\.core\.gz"\]\s*=\s*([A-Za-z0-9_]+)/);
if (!coreGzMatch) throw new Error('Could not find core.core.gz in moonpad-monaco.js');
const coreGzVarName = coreGzMatch[1];
const coreGzVarRegex = new RegExp('\\b' + coreGzVarName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\s*=\\s*Q\\("([^"]+)"\\)');
const coreGzVm = coreGzVarRegex.exec(content);
if (!coreGzVm) throw new Error('Could not find core.core.gz data in moonpad-monaco.js');
const coreGzB64 = coreGzVm[1];
const coreCoreB64 = gunzipSync(Buffer.from(coreGzB64, 'base64')).toString('base64');

// Generate core-map.js
const lines = [
  '// AUTO-GENERATED by scripts/generate-core-map.mjs - do not edit manually',
  '// Run `npm install` to regenerate from public/moonpad-monaco.js',
  '',
  "const b64 = (s) => typeof Buffer !== 'undefined'",
  "  ? new Uint8Array(Buffer.from(s, 'base64'))",
  "  : Uint8Array.from(atob(s), (c) => c.charCodeAt(0));",
  '',
  `export const corePkgs = ${JSON.stringify(corePkgs, null, 2)};`,
  '',
  'export const coreMap = {',
  ...Object.entries(miMap).map(([k, v]) => `  ${JSON.stringify(k)}: b64(${JSON.stringify(v)}),`),
  '};',
  '',
  `export const coreGz = b64(${JSON.stringify(coreGzB64)});`,
  '',
  `export const coreCore = b64(${JSON.stringify(coreCoreB64)});`,
  '',
];

writeFileSync(outputPath, lines.join('\n'));
console.log(`Generated ${outputPath} (${Object.keys(miMap).length} MI files, core.core.gz: ${Math.round(coreGzB64.length * 3 / 4 / 1024)} KB compressed)`);
